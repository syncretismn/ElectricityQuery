{% extends "base.html" %}

{% block title %}Meter Reading{% endblock %}

{% block content %}
    <h2>Meter Reading</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <p class="{{ category }}">{{ message }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div id="server-status">
        <p><strong>Server Status:</strong> <span id="api-status">Checking...</span></p>
    </div>

    <form action="{{ url_for('reading') }}" method="POST">
        <label for="meter_id">Meter ID:</label>
        <input type="text" name="meter_id" required><br>

        <label for="meter_value">Electricity Usage (kWh):</label>
        <input type="number" step="0.01" name="meter_value" required><br>

        <label for="update_time">Update Time (YYYY-MM-DD HH:MM:SS):</label>
        <input type="text" name="update_time" placeholder="2025-02-18 14:30:00" required><br>

        <button type="submit">Submit Reading</button>
    </form>

    <form action="{{ url_for('reading') }}" method="POST" enctype="multipart/form-data">
        <label for="file">Upload CSV File:</label>
        <input type="file" name="file" accept=".csv" required><br>
        <button type="submit">Upload CSV</button>
    </form>

    <script>
        async function checkServerStatus() {
            try {
                const response = await fetch("{{ url_for('stop_server_status') }}");
                const data = await response.json();
                document.getElementById("api-status").innerText = data.stop_server ? "❌ API Offline (00:00 - 01:00)" : "✅ API Online";
                document.getElementById("api-status").style.color = data.stop_server ? "red" : "green";
            } catch (error) {
                document.getElementById("api-status").innerText = "⚠️ Error fetching API status";
                document.getElementById("api-status").style.color = "orange";
            }
        }

        setInterval(checkServerStatus, 5000);
        checkServerStatus();
    </script>
{% endblock %}
